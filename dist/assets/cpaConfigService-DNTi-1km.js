var g=Object.defineProperty;var v=(n,a,e)=>a in n?g(n,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[a]=e;var u=(n,a,e)=>v(n,typeof a!="symbol"?a+"":a,e);import{a as f}from"./index-CefY7xy0.js";const d={CONFIG:"https://fature-config-service-production.up.railway.app",COMMISSION:"https://fature-commission-service-production.up.railway.app",MLM:"https://fature-mlm-service-v2-production.up.railway.app",DATA:"https://fature-data-service-v2-production.up.railway.app"},p=f.create({timeout:3e4,headers:{"Content-Type":"application/json"}});class h{constructor(){u(this,"cache",new Map);u(this,"cacheTimeout",2*60*1e3)}getCacheKey(a){return`cpa_config_${a}`}getCachedData(a){const e=this.cache.get(a);return e&&Date.now()-e.timestamp<this.cacheTimeout?(console.log("üì¶ Usando configura√ß√µes CPA do cache:",a),e.data):null}setCachedData(a,e){this.cache.set(a,{data:e,timestamp:Date.now()})}async getCpaConfiguration(){const a=this.getCacheKey("configuration"),e=this.getCachedData(a);if(e)return e;try{console.log("‚öôÔ∏è Buscando configura√ß√µes CPA do Railway Config Service...");const t=await p.get(`${d.CONFIG}/api/v1/cpa/config`);if(t.data&&t.data.success){const o=t.data.data;return this.setCachedData(a,o),console.log("‚úÖ Configura√ß√µes CPA carregadas do Railway:",o),o}}catch(t){console.error("‚ùå Erro ao buscar configura√ß√µes CPA do Railway:",t)}const r={levels:[{level:1,value:50},{level:2,value:20},{level:3,value:5},{level:4,value:5},{level:5,value:5}],totalAmount:85,validationRules:[{id:"rule_flexible_1",name:"Modelo Flex√≠vel (Padr√£o)",description:"(Dep√≥sito 30 E Apostas 10) OU (Dep√≥sito 30 E GGR 25)",groups:[{id:"group_1",name:"Grupo 1: Dep√≥sito + Apostas",criteria:[{id:"dep_1",type:"deposit",value:30,enabled:!0},{id:"bet_1",type:"bets",value:10,enabled:!0},{id:"ggr_1",type:"ggr",value:0,enabled:!1}],operator:"AND"},{id:"group_2",name:"Grupo 2: Dep√≥sito + GGR",criteria:[{id:"dep_2",type:"deposit",value:30,enabled:!0},{id:"bet_2",type:"bets",value:0,enabled:!1},{id:"ggr_2",type:"ggr",value:25,enabled:!0}],operator:"AND"}],groupOperator:"OR",active:!0}]};return r.activeRule=r.validationRules.find(t=>t.active),this.setCachedData(a,r),console.log("üîÑ Usando configura√ß√µes CPA padr√£o (fallback):",r),r}async getValidatedCpaCommissions(a,e,r){try{console.log("üí∞ Buscando comiss√µes CPA validadas do Railway Commission Service...");let t=`${d.COMMISSION}/commissions/cpa`;const o=new URLSearchParams;a&&o.append("affiliate_id",a.toString()),e&&o.append("start_date",e),r&&o.append("end_date",r),o.toString()&&(t+=`?${o.toString()}`);const s=await p.get(t);if(s.data&&s.data.success)return console.log("‚úÖ Comiss√µes CPA carregadas do Railway:",s.data.data),s.data.data}catch(t){console.error("‚ùå Erro ao buscar comiss√µes CPA do Railway:",t)}return console.log("üîÑ Usando fallback para comiss√µes CPA (array vazio)"),[]}async getMlmData(a=1,e=20,r,t){try{console.log("üåê Buscando dados MLM do Railway MLM Service...");let o=`${d.MLM}/api/v1/mlm/affiliates`;const s=new URLSearchParams;s.append("page",a.toString()),s.append("limit",e.toString()),r&&s.append("start_date",r),t&&s.append("end_date",t),o+=`?${s.toString()}`;const c=await p.get(o);if(c.data&&c.data.success)return console.log("‚úÖ Dados MLM carregados do Railway:",c.data),c.data}catch(o){console.error("‚ùå Erro ao buscar dados MLM do Railway:",o)}return{success:!1,data:[],pagination:{page:1,pages:1,total:0,limit:e}}}async getCpaStats(a,e){try{console.log("üìä Buscando estat√≠sticas CPA do Railway Data Service...");let r=`${d.DATA}/api/v1/analytics/cpa-stats`;const t=new URLSearchParams;a&&t.append("start_date",a),e&&t.append("end_date",e),t.toString()&&(r+=`?${t.toString()}`);const o=await p.get(r);if(o.data&&o.data.success)return console.log("‚úÖ Estat√≠sticas CPA carregadas do Railway:",o.data.data),o.data.data}catch(r){console.error("‚ùå Erro ao buscar estat√≠sticas CPA do Railway:",r)}return{total_affiliates_with_cpa:0,total_cpa_paid:0,total_rev_paid:0,total_paid:0,average_cpa_per_affiliate:0}}async getCpaLevelValues(){try{return(await this.getCpaConfiguration()).levels}catch(a){return console.error("‚ùå Erro ao buscar valores CPA por n√≠vel:",a),[{level:1,value:50},{level:2,value:20},{level:3,value:5},{level:4,value:5},{level:5,value:5}]}}async getActiveValidationRule(){try{return(await this.getCpaConfiguration()).activeRule||null}catch(a){return console.error("‚ùå Erro ao buscar regra de valida√ß√£o ativa:",a),null}}async validatePlayerForCpa(a){try{const e=await this.getActiveValidationRule();if(!e)return console.log("‚ö†Ô∏è Nenhuma regra de valida√ß√£o CPA ativa"),!1;console.log("üîç Validando jogador com regra:",e.name),console.log("üìä Dados do jogador:",a);const r=e.groups.map(o=>{const s=o.criteria.filter(l=>l.enabled).map(l=>{let i=!1;switch(l.type){case"deposit":i=a.totalDeposit>=l.value;break;case"bets":i=a.totalBets>=l.value;break;case"ggr":i=a.totalGgr>=l.value;break}return console.log(`  ${l.type}: ${i} (${a[l.type==="deposit"?"totalDeposit":l.type==="bets"?"totalBets":"totalGgr"]} >= ${l.value})`),i}),c=o.operator==="AND"?s.every(l=>l):s.some(l=>l);return console.log(`  Grupo "${o.name}": ${c} (${o.operator})`),c}),t=e.groupOperator==="AND"?r.every(o=>o):r.some(o=>o);return console.log(`‚úÖ Resultado final da valida√ß√£o CPA: ${t} (${e.groupOperator})`),t}catch(e){return console.error("‚ùå Erro na valida√ß√£o CPA:",e),!1}}async testRailwayServices(){const a={};for(const[e,r]of Object.entries(d))try{console.log(`üîç Testando ${e}: ${r}`);const t=["/health","/api/v1/health","/api/health"];let o=!1;for(const s of t)try{if((await p.get(`${r}${s}`)).status===200){o=!0,console.log(`‚úÖ ${e} conectado via ${s}`);break}}catch{}a[e]=o,o||console.log(`‚ùå ${e} n√£o conectado`)}catch(t){console.error(`‚ùå Erro ao testar ${e}:`,t),a[e]=!1}return a}clearCache(){this.cache.clear(),console.log("üßπ Cache de configura√ß√µes CPA limpo")}}const m=new h;export{m as cpaConfigService,m as default};
